<!--components/results-table/results-table.component.html-->
<!-- - Simple inline error display for table actions -->
<div class="error" *ngIf="errorMessage">{{ errorMessage }}</div>

<div class="table-wrap" *ngIf="(items?.length ?? 0) > 0; else noRows">
    <table>
        <thead>
            <tr>
                <!-- - (done) the expansion column no text but for an expander button -->
                <th class="expander"></th>
                <!-- Headers so be sortable on a click -->
                <!-- - (done) partNumber -->
                <!-- - (done) supplierSku -->
                <!-- - (done) description -->
                <!-- - (done) branch -->
                <!-- - (done) availableQty -->
                <!-- - (done) uom -->
                <!-- - (done) leadTimeDays -->
                <!-- - (done) lastPurchaseDate -->
                <th *ngFor="let h of headers" (click)="onHeaderClick(h.field)">{{ h.label }}</th>
                <!-- - TODO: Action peak availability button) -->
                <th class="action-col">Peak availability</th>
            </tr>
        </thead>
        <tbody>
            <ng-container *ngFor="let item of items ?? []; trackBy: trackByItem">
                <tr>
                    <!-- hint use <button (click)="toggleExpand(item)" aria-label="expand row">?</button> -->
                    <td class="expander">
                        <button type="button" (click)="toggleExpand(item)" aria-label="expand row">
                            {{ expanded[itemKey(item)] ? '-' : '+' }}
                        </button>
                    </td>
                    <td>{{ item.partNumber }}</td>
                    <td>{{ item.supplierSku }}</td>
                    <td>{{ item.description }}</td>
                    <td>{{ item.branch }}</td>
                    <td class="num">{{ item.availableQty }}</td>
                    <td>{{ item.uom }}</td>
                    <td class="num">{{ item.leadTimeDays ?? 'N/A' }}</td>
                    <td>{{ item.lastPurchaseDate || 'N/A' }}</td>
                    <td>
                        <!-- use (click)="onPeakButton(item)" for peakAvailability button -->
                        <!-- on clicking the button should be disabled with a loading indicator then once the data is loaded the
                             button should go back to normal state and the data appears below the row and the lot information -->
                        <button type="button"
                                (click)="onPeakButton(item)"
                                [disabled]="peakLoading[itemKey(item)]">
                            <span *ngIf="peakLoading[itemKey(item)]">Loading...</span>
                            <span *ngIf="!peakLoading[itemKey(item)]">Load peak availability</span>
                        </button>
                    </td>
                </tr>
                <tr *ngIf="expanded[itemKey(item)]" class="expand-row">
                    <td colspan="10">
                        <div class="lots">
                            <strong>Lots</strong>
                            <!-- This button should also display the Lot information similar to the expander button at the beginning -->
                            <ng-container *ngIf="item.lots?.length; else noLots">
                                <div *ngFor="let lot of item.lots">
                                    Lot {{ lot.lotNumber }} - Qty {{ lot.qty }} - Exp {{ lot.expirationDate || 'N/A' }}
                                </div>
                            </ng-container>
                            <ng-template #noLots>
                                <div class="muted">No lots listed.</div>
                            </ng-template>
                        </div>
                        <div class="peak">
                            <ng-container *ngIf="peakFor(item) as peak; else noPeak">
                                <div><strong>Part:</strong> {{ peak.partNumber || item.partNumber }}</div>
                                <div><strong>Total available:</strong> {{ peak.totalAvailable ?? 0 }}</div>
                                <div><strong>By branch:</strong></div>
                                <div class="branches">
                                    <div *ngFor="let b of peak.branches">{{ b.branch }}: {{ b.qty }}</div>
                                </div>
                            </ng-container>
                            <ng-template #noPeak>
                                <!-- Note befoe the data appears the message No peak availability loaded yet. Should be displayed -->
                                <!-- The expander button the display the No peak availability loaded yet if not yet loaded -->
                                <div class="muted">No peak availability loaded yet.</div>
                            </ng-template>
                        </div>
                    </td>
                </tr>
            </ng-container>
        </tbody>
    </table>
</div>
<ng-template #noRows>
    <div class="empty">No results to display.</div>
</ng-template>

<!-- Simple pagination controls  -->
<div class="pager" aria-label="Pagination">
    <button type="button" (click)="goTo(pageIndex - 1)" [disabled]="pageIndex <= 0">Prev</button>
    <span>Page {{ pageIndex + 1 }} / {{ totalPages(total, pageSize) }}</span>
    <button type="button" (click)="goTo(pageIndex + 1)" [disabled]="pageIndex >= totalPages(total, pageSize) - 1">
        Next
    </button>
</div>
