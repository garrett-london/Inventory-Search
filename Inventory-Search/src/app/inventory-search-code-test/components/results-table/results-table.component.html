<div class="showing" *ngIf="showingRange() as range">
    {{ range.start }}-{{ range.end }} of {{ totalResults }} results
</div>
<div class="table-wrap" *ngIf="(items?.length ?? 0) > 0; else noRows">
    <table>
        <thead>
            <tr>
                <th class="expander"></th>
                <th *ngFor="let h of headers"
                    [class.sortable]="h.sortable"
                    (click)="h.sortable && onHeaderClick(h.field)">
                    {{ h.label }}
                </th>

                <th class="action-col">Peak availability</th>
            </tr>
        </thead>
        <tbody>
            <ng-container *ngFor="let item of items ?? []; trackBy: trackByItem">
                <tr>
                    <td class="expander">
                        <button type="button" (click)="toggleExpand(item)" aria-label="expand row">
                            {{ expanded[itemKey(item)] ? '-' : '+' }}
                        </button>
                    </td>
                    <td>{{ item.partNumber }}</td>
                    <td>{{ item.supplierSku }}</td>
                    <td>{{ item.description }}</td>
                    <td>{{ item.branch }}</td>
                    <td class="num">{{ item.availableQty }}</td>
                    <td>{{ item.uom }}</td>
                    <td class="num">{{ item.leadTimeDays ?? 'N/A' }}</td>
                    <td>{{ item.lastPurchaseDate || 'N/A' }}</td>
                    <td>
                        <button type="button"
                                (click)="onPeakButton(item)"
                                [disabled]="peakLoading[itemKey(item)] || !!peakFor(item)">
                            <span *ngIf="peakLoading[itemKey(item)]">
                                Loading...
                            </span>
                            <span *ngIf="!peakLoading[itemKey(item)] && !peakFor(item)">
                                Load peak availability
                            </span>
                            <span *ngIf="!peakLoading[itemKey(item)] && peakFor(item)" class="btn-loaded">
                                Availability fetched
                            </span>
                        </button>
                    </td>
                </tr>
                <tr *ngIf="expanded[itemKey(item)]" class="expand-row">
                    <td colspan="10">
                        <div class="lots">
                            <strong>Lots</strong>
                            <ng-container *ngIf="item.lots?.length; else noLots">
                                <div *ngFor="let lot of item.lots">
                                    Lot {{ lot.lotNumber }} - Qty {{ lot.qty }} - Exp {{ lot.expirationDate || 'N/A' }}
                                </div>
                            </ng-container>
                            <ng-template #noLots>
                                <div class="muted">No lots listed.</div>
                            </ng-template>
                        </div>
                        <div class="peak">
                            <ng-container *ngIf="peakFor(item) as peak; else noPeak">
                                <div><strong>Part:</strong> {{ peak.partNumber || item.partNumber }}</div>
                                <div><strong>Total available:</strong> {{ peak.totalAvailable }}</div>
                                <div><strong>By branch:</strong></div>
                                <div class="branches">
                                    <div *ngFor="let b of peak.branches">{{ b.branch }}: {{ b.qty }}</div>
                                </div>
                            </ng-container>
                            <ng-template #noPeak>
                                <div class="muted">No peak availability loaded yet.</div>
                            </ng-template>
                        </div>
                    </td>
                </tr>
            </ng-container>
        </tbody>
    </table>
</div>
<ng-template #noRows>
    <div class="empty">No results to display.</div>
</ng-template>
<div class="pager" aria-label="Pagination">
    <button type="button"
            class="pager-btn"
            (click)="goTo(pageIndex - 1)"
            [disabled]="pageIndex <= 0"
            aria-label="Previous page"><
    </button>

    <span>Page {{ pageIndex + 1 }} / {{ totalPages(total, pageSize) }}</span>

    <button type="button"
            class="pager-btn"
            (click)="goTo(pageIndex + 1)"
            [disabled]="pageIndex >= totalPages(total, pageSize) - 1"
            aria-label="Next page">>
    </button>
</div>
